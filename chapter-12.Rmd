# Discriminant Analysis and Other Linear Classification Models

```{r chapter-10-startup, include = FALSE}
knitr::opts_chunk$set(fig.path = "figures/")
library(MASS)
library(mixOmics)
library(plsmod)
library(glmnet)
library(tidymodels)
library(tbd)
library(discrim)

caching <- TRUE

cores <- parallel::detectCores()
if (!grepl("mingw32", R.Version()$platform)) {
 library(doMC)
 registerDoMC(cores = cores)
} else {
  library(doParallel)
  cl <- makePSOCKcluster(cores)
  registerDoParallel(cl)
}

source("extras/overlay_roc_curves.R")
```


The R packages used in this chapter are: `r pkg_text(c("tidymodels", "MASS", "discrim", "glmnet",
"mixOmics", "plsmod"))`. 


## Case Study: Predicting Successful Grant Applications


```{r chapter-12-data}
library(tidymodels)
data(grants)

ls(pattern = "grants")

load("RData/grants_split.RData")

grants_split
nrow(grants_test)
```


## Logistic Regression

```{r chapter-12-logistic, cache = caching}
library(tbd)

rs_ctrl <- control_resamples(save_pred = TRUE, save_workflow = TRUE, 
                             parallel_over = "everything")


zv_rec <- 
 recipe(class ~ ., data = grants_other) %>% 
 step_dummy(all_nominal(), -class) %>% 
 step_zv(all_predictors())

nzv_rec <- 
 recipe(class ~ ., data = grants_other) %>% 
 step_dummy(all_nominal(), -class) %>% 
 step_nzv(all_predictors())

logistic_spec <-
 logistic_reg() %>% 
 set_engine("glm")

logistic_wflow_set <- 
 workflow_set(
  preproc = list(none = zv_rec, nzv = nzv_rec),
  models =  list(logistic = logistic_spec),
  cross = TRUE
 ) %>% 
 workflow_map(fn = "fit_resamples", resamples = grants_split, seed = 1201,
              control = rs_ctrl)
 
model_predictions <- 
 map(logistic_wflow_set$result, collect_predictions) %>% 
 map2_dfr(logistic_wflow_set$wflow_id, ~ mutate(.x, model = .y))

map(logistic_wflow_set$result, collect_metrics) 
```


```{r chapter-12-fig-04}
overlay_roc_curves(model_predictions, highlight = "nzv_logistic") 
```


## Linear Discriminant Analysis


```{r chapter-12-lda, cache = caching}
library(discrim)

lda_spec <-
 discrim_linear() %>% 
 set_engine("MASS")

lda_wflow_set <- 
 workflow_set(
  preproc = list(none = zv_rec, nzv = nzv_rec),
  models =  list(LDA = lda_spec),
  cross = TRUE
 ) %>% 
 workflow_map(fn = "fit_resamples", resamples = grants_split, seed = 1201,
              control = rs_ctrl)
 
model_predictions <- 
 map(lda_wflow_set$result, collect_predictions) %>% 
 map2_dfr(lda_wflow_set$wflow_id, ~ mutate(.x, model = .y)) %>% 
 bind_rows(model_predictions)

map(lda_wflow_set$result, collect_metrics) 
```


```{r chapter-12-fig-09}
overlay_roc_curves(model_predictions, highlight = "nzv_LDA") 
```

## Partial Least Squares Discriminant Analysis



```{r chapter-12-pls, cache = caching}
library(plsmod)

pls_spec <-
 pls(num_comp = tune()) %>% 
 set_mode("classification") %>% 
 set_engine("mixOmics")

gd_ctrl <- control_grid(save_pred = TRUE, save_workflow = TRUE, 
                             parallel_over = "everything")

pls_wflow_set <- 
 workflow_set(
  preproc = list(none = zv_rec, nzv = nzv_rec),
  models =  list(PLS = pls_spec),
  cross = TRUE
 ) %>% 
 workflow_map(resamples = grants_split, seed = 1201, grid = tibble(num_comp = 1:10),
              control = gd_ctrl)
 
```


```{r chapter-12-fig-12}
map(pls_wflow_set$result, collect_metrics) %>% 
 map2_dfr(pls_wflow_set$wflow_id, ~ mutate(.x, model = .y)) %>% 
 filter(.metric == "roc_auc") %>% 
 ggplot(aes(x = num_comp, y = mean, col = model)) + 
 geom_point() + 
 geom_line() + 
 labs(x = "Number of PLS Components", y = "roc_auc")
```


```{r chapter-12-fig-13}

model_predictions <- 
 map(pls_wflow_set$result, collect_predictions) %>% 
 map2_dfr(pls_wflow_set$wflow_id, ~ mutate(.x, model = .y)) %>% 
 filter(num_comp == 4) %>% 
 select(-num_comp) %>% 
 bind_rows(model_predictions)

overlay_roc_curves(model_predictions, highlight = "nzv_PLS") 
```


## Penalized Models




```{r chapter-12-glmnet, cache = caching}
glmnet_spec <-
 logistic_reg(penalty = tune(), mixture = tune()) %>% 
 set_mode("classification") %>% 
 set_engine("glmnet")

glmn_grid <-
        tidyr::crossing(
          penalty = 10 ^ seq(-3, 0, length.out = 20),
          mixture = c(0.05, .2, .4, .6, .8, 1)
        )

glmnet_wflow <- 
 workflow() %>% 
 add_model(glmnet_spec) %>% 
 add_recipe(zv_rec)

set.seed(1201)
glmnet_tune <- 
 glmnet_wflow %>% 
 tune_grid(resamples = grants_split, grid = glmn_grid,
              control = gd_ctrl)
 
glmnet_best <- select_best(glmnet_tune, metric = "roc_auc")

model_predictions <- 
 collect_predictions(glmnet_tune, parameters = glmnet_best) %>% 
 mutate(model = "glmnet") %>% 
 select(-penalty, -mixture) %>% 
 bind_rows(model_predictions)
```


```{r chapter-12-fig-16a}
autoplot(glmnet_tune, metric = "roc_auc")
```

```{r chapter-12-fig-16b}
overlay_roc_curves(model_predictions, highlight = "glmnet") 
```

## Nearest Shrunken Centroids






```{r chapter-12-teardown, include = FALSE}
if (grepl("mingw32", R.Version()$platform)) {
 stopCluster(cl)
} 

save(logistic_wflow_set, lda_wflow_set, pls_wflow_set, glmnet_tune,
     model_predictions,
     version = 2, compress = "xz", file = "RData/chapter_12.RData")
```


